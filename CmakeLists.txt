cmake_minimum_required(VERSION 3.20)

project(cppDL
    LANGUAGES CXX
)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

option(USE_AVX256 "Enable AVX2/FMA etc." ON)
option(DEBUG "Enable DEBUG" OFF)
option(USE_BLAS "Enable CRUSHBLAS acceleration" ON)
option(USE_VULKAN "Enable Vulkan support" OFF)
option(USE_OPENGL "Enable OpenGL support" OFF)

if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Debug CACHE STRING "Build type" FORCE)
endif()

if(MSVC)
    add_compile_options(/W4)
else()
    add_compile_options(-Wall -Wextra -Wpedantic)
endif()

set(SRC_DIRS
    test_bed/src
    core/impl/neural_core_impl
    core/impl/tokenizer_core_impl
    core/utils/dashboard.hpp
    core/include/CRUSHBLAS_MODULE/core/impl/blas_impl/level3
    core/include/CRUSHBLAS_MODULE/core/impl/core_impl/matrix_impl
)

set(SRCS "")
foreach(dir IN LISTS SRC_DIRS)
    file(GLOB SRCS_IN_DIR "${dir}/*.cpp")
    list(APPEND SRCS ${SRCS_IN_DIR})
endforeach()

add_executable(cppDL ${SRCS})

if(WIN32)
    add_custom_target(run
        COMMAND "${CMAKE_CURRENT_SOURCE_DIR}/run.bat"
        DEPENDS cppDL
        WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
        COMMENT "Building and running cppDL via run.bat"
    )
endif()

if(USE_AVX256)
    target_compile_definitions(cppDL PRIVATE USE_AVX256=1)
    if(MSVC)
        target_compile_options(cppDL PRIVATE /O2 /arch:AVX2)
    else()
        target_compile_options(cppDL PRIVATE
            -Ofast
            -O3
            -march=native
            -mavx2
            -mfma
            -mavx
        )
    endif()

    find_package(OpenMP)
    if(OpenMP_CXX_FOUND)
        target_link_libraries(cppDL PRIVATE OpenMP::OpenMP_CXX)
    endif()
else()
    target_compile_definitions(cppDL PRIVATE USE_AVX256=0)
endif()

if(USE_BLAS)
    target_compile_definitions(cppDL PRIVATE USE_BLAS=1)
    if(MSVC)
        target_compile_options(cppDL PRIVATE /O2 /arch:AVX2)
    else()
        target_compile_options(cppDL PRIVATE
            -Ofast
            -O3
            -march=native
            -mavx2
            -mfma
            -mavx
        )
    endif()

    find_package(OpenMP)
    if(OpenMP_CXX_FOUND)
        target_link_libraries(cppDL PRIVATE OpenMP::OpenMP_CXX)
    endif()
else()
    target_compile_definitions(cppDL PRIVATE USE_BLAS=0)
endif()

if(USE_VULKAN)
    target_compile_definitions(cppDL PRIVATE USE_VULKAN=1)
else()
    target_compile_definitions(cppDL PRIVATE USE_VULKAN=0)
endif()

if(USE_OPENGL)
    target_compile_definitions(cppDL PRIVATE USE_OPENGL=1)
else()
    target_compile_definitions(cppDL PRIVATE USE_OPENGL=0)
endif()

